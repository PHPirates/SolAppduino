\documentclass{article}
\usepackage{hyperref} % used for links
\usepackage{listings}
\usepackage{circuitikz}

\lstset{language=C, basicstyle=\ttfamily, breaklines=true}

% Hyperlink setup
\hypersetup{
	colorlinks=true,
	linkcolor=blue,
	filecolor=magenta,      
	urlcolor=cyan,
}

% circuitikz shapes ---------------
\makeatletter
% create the shape (switch without arrow) 
\pgfcircdeclarebipole{}{\ctikzvalof{bipoles/interr/height 2}}{spst}{\ctikzvalof{bipoles/interr/height}}{\ctikzvalof{bipoles/interr/width}}{
	
	\pgfsetlinewidth{\pgfkeysvalueof{/tikz/circuitikz/bipoles/thickness}\pgfstartlinewidth}
	
	\pgfpathmoveto{\pgfpoint{\pgf@circ@res@left}{0pt}}
	\pgfpathlineto{\pgfpoint{.6\pgf@circ@res@right}{\pgf@circ@res@up}}
	\pgfusepath{draw}   
}

% make the shape accessible with nice syntax
\def\pgf@circ@spst@path#1{\pgf@circ@bipole@path{spst}{#1}}
\tikzset{switch/.style = {\circuitikzbasekey, /tikz/to path=\pgf@circ@spst@path, l=#1}}
\tikzset{spst/.style = {switch = #1}}
\makeatother
% --------------------------------

\begin{document}
	\section{Setup of the project}
	\subsection{Hardware used}
	We used an Arduino Nano ATmega328, bought at \href{http://nl.rs-online.com/}{rs-components}.
	
	We used a \href{http://www.mijn-gadgets.nl/Webwinkel-Product-157562595/ENC28J60-Ethernet-Shield-Network-Module-V1.0-For-Arduino-Nano.html}{ENC28j60 Ethernet shield}, the version specifically for the nano. This seemed easier than a wifi shield because of this reason, and with a wifi shield it seemed we needed extra components and a circuit, and we didn't really understand it.

	\subsubsection{Button circuit}
		We implemented the begin- and endstops in the circuit for the buttons that move the panels up and down. When a button is NOT pushed, 1 and 1B, and 2 and 2B of that button are connected. When a button is pushed, connections are made between 1 and 1A, and 2 and 2A of that button.
		\begin{center}\begin{circuitikz}
			\draw 
			% 20, 28, E4
				(4,0) node {20} 
				(6,0) node {28}
				(8,0) node {E4}
				
			% button hoog
				(1 , -6) node {button up}
				(2.25, -5.25) node {1A}
				(2.25, -6) node {1}
				(2.25, -6.75) node {1B}
				(3.75, -5.25) node {2A}
				(3.75, -6) node {2}
				(3.75, -6.75) node {2B}
			
			% button laag
				(10 ,-6) node {button down}
				(7.25, -5.25) node {1A}
				(7.25,-6) node {1}
				(7.25, -6.75) node {1B}
				(8.5, -5.25) node {2A}
				(8.5, -6) node {2}
				(8.5, -6.75) node {2B}
				
			% drawing
				% 28 to 1,2 hoog via eindstoppen
					(6,-0.25) to (6,-1)
						to (3,-1) 
						to (3,-2)
					(2.5,-2) to (3.5,-2)
					(2.5,-2) to[switch, l_= high end stop] (2.5,-4) %eindstop hoog
						to (1.75,-4)
						to (1.75,-6) to (2,-6) 
					(3.5,-2) to[switch = low end stop] (3.5,-4) %eindstop laag
						to (4.25,-4)
						to (4.25,-6) to (4,-6) 
				% 1A hoog to 1B laag
					(2,-5.25) to (1.9,-5.25)
						to (1.9,-4.75)
						to(5.75,-4.75)
						to(5.75,-6.75)
						to(7,-6.75)
				% 2B hoog to 1A laag
					(4,-6.75) to (5.25,-6.75)
						to (5.25,-5.25)
						to (7,-5.25)
				% 20 to 1 laag
					(4,-0.25) to (4,-1.25)
						to (6.25,-1.25)
						to (6.25,-6)
						to (7,-6)
				% 1 laag to 2 laag
					(7.5,-6) to (8.25,-6)
				% E4 to 2A laag
					(8,-0.25) to (8,-4.75)
						to (9,-4.75)
						to (9,-5.25)
						to (8.75,-5.25)
			;
		\end{circuitikz}\end{center}
	\subsubsection{Potentiometer}
	The yellow-green wire from the potentiometer to the main control box is the signal wire, on connection 8 in that box. With the Arduino we measured 74 (analog in so scale 0-1024) in the highest position and 360 in the lowest position, with connection 9 to ground on the Arduino.
	\subsubsection{Motor control}
	We bought BC517 NPN transistors to control the 12V/20mA (\href{http://download.lenze.com/TD/8201-8204__Inverter__v02-08__EN.pdf }{docs}, page 4-11) or 14V/40mA (measured) current of the EVF8202-E frequency inverter, and also ...K ohm base resistors otherwise the Arduino needs to give too much current to the transistor, and the transistor will be slow to turn off because of 'base charge storage'.

	\subsection{Software used}
	We decided on the \href{http://platformio.org/platformio-ide}{PlatformIO IDE}, (which uses python 2.7 and Clang for autocompletion) because it is a lot better than the standard Arduino IDE, and also seemed better than the Stino plugin for Sublime Text 3. A plugin for CLion also looked good but we didn't get that to work. PlatformIO only worked when we imported an existing Arduino project, creating new files or new projects resulted in all kinds of errors.
	
	\section{Code}
		\subsection{Internet/Ethernet connection}
			To connect the Arduino and the Ethernet shield to the internet, we used the \href{https://github.com/jcw/ethercard}{EtherCard} library. Because the ENC28j60 uses a different default CS pin (10 instead of 8), we had to add that in the code when making the connection. This is done by changing
			\begin{lstlisting}
if (ether.begin(sizeof Ethernet::buffer, mymac) == 0)
			\end{lstlisting}
			(with no pin specified, so the default pin is used) to
			\begin{lstlisting}
if (ether.begin(sizeof Ethernet::buffer, mymac, 10) == 0)
			\end{lstlisting}
			Note the third argument \lstinline|10| added after \lstinline|mymac|.

		\subsection{Solar Panel control}
			The calculation to find the goal value of the potmeter is with half a degree accuracy because of integer division and the resulting decimal truncation. The offset can be seen with this Mathematica command:
			\begin{lstlisting}
Plot[
N[360 + ( Floor[(x - 5) * 100 / (50 - 5) ]) * (74 - 360) /100] - 
N[360 + ( (x - 5) * 100 / (50 - 5) ) * (74 - 360) /100]
, {x, 10, 15}]
			\end{lstlisting}
			The idea is to keep setting the right pins high until the difference between the current voltage and the expected voltage is less than 3 'voltage points', about half a degree.
			
			To get the current time using NTP, we adapted \href{http://forum.arduino.cc/index.php?topic=171941.0}{example code} from the Arduino forum.
			
		\subsection{Communication with the Android app}
			Communication goes by http requests, in the form of \verb|http://192.168.2.10/?panel=up|. Currently implemented are \verb|panel=up,panel=down,panel=stop,panel=auto|, but these actions do not do anything yet. When you request \verb|http://192.168.2.10/| you get a homepage with the current status of the solar panels (currently just the internal time of the Arduino...).
			
			On every action sent, the Arduino will send back an http response starting with \verb|HTTP/1.1 200 OK|, and including something like \verb|<h1>Panels going up</h1>|.
	
\end{document}